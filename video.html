<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Player</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: black;
        overflow: hidden;
      }

      #video-player {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: black;
      }

      #video-player::-webkit-media-controls {
        display: none !important;
      }

      #black-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 9999;
        display: none;
      }
    </style>
  </head>
  <body>
    <video id="video-player" muted></video>
    <div id="black-overlay"></div>

    <script>
      let isReceivingSeek = false;
      let videoHasEnded = false;
      let isLoopRestarting = false;

      const video = document.getElementById("video-player");
      const overlay = document.getElementById("black-overlay");

      function setOverlay(show) {
        overlay.style.display = show ? "block" : "none";
      }

      function isVideoAtEnd() {
        return video.ended || (video.duration && video.currentTime >= video.duration - 1);
      }

      function sendMessage(type, data = {}) {
        if (window.opener) {
          try {
            window.opener.postMessage({ type, data }, window.location.origin);
          } catch (e) {}
        }
      }

      // Message handling
      window.addEventListener("message", (event) => {
        if (event.origin !== window.location.origin) return;

        const { type, data } = event.data;

        switch (type) {
          case "LOAD_VIDEO":
            videoHasEnded = false;
            isLoopRestarting = false;
            video.src = data.url;
            video.muted = true;
            video.controls = false;
            setOverlay(false);
            break;

          case "PLAY":
            if ((!videoHasEnded && !video.ended) || isLoopRestarting) {
              videoHasEnded = false;
              setOverlay(false);
              video.play().catch((e) => console.warn("Play failed:", e));
            }
            break;

          case "PAUSE":
            video.pause();
            if (videoHasEnded || isVideoAtEnd()) {
              setOverlay(true);
            }
            break;

          case "SEEK":
            if (data?.time !== undefined && !videoHasEnded) {
              isReceivingSeek = true;
              video.currentTime = data.time;
              setTimeout(() => { isReceivingSeek = false; }, 100);
            }
            break;

          case "SET_PLAYBACK_RATE":
            if (data?.rate !== undefined) {
              video.playbackRate = data.rate;
            }
            break;

          case "GET_VIDEO_STATUS":
            sendMessage("VIDEO_STATUS_RESPONSE", {
              hasEnded: videoHasEnded,
              ended: video.ended,
              paused: video.paused,
              currentTime: video.currentTime,
              duration: video.duration,
              isLoopRestarting: isLoopRestarting
            });
            break;

          case "RESTART_VIDEO":
            isLoopRestarting = true;
            videoHasEnded = false;
            setOverlay(false);
            video.pause();
            
            if (isVideoAtEnd()) {
              const src = video.src;
              video.src = "";
              video.load();
              video.src = src;
              video.load();
            }
            
            video.currentTime = 0;
            setTimeout(() => {
              video.play().then(() => {
                isLoopRestarting = false;
                setOverlay(false);
              }).catch(() => {
                isLoopRestarting = false;
              });
            }, 100);
            break;

          case "RESET_VIDEO":
            isLoopRestarting = false;
            videoHasEnded = false;
            video.pause();
            
            const src = video.src;
            video.src = "";
            video.load();
            video.src = src;
            video.load();
            
            video.currentTime = 0;
            setOverlay(true);
            break;
        }
      });

      // Video events
      video.addEventListener("play", () => {
        videoHasEnded = false;
        setOverlay(false);
        if (!isReceivingSeek) {
          sendMessage("VIDEO_PLAY");
        }
      });

      video.addEventListener("pause", () => {
        if (videoHasEnded || isVideoAtEnd()) {
          setOverlay(true);
        }
        if (!isReceivingSeek) {
          sendMessage("VIDEO_PAUSE");
        }
      });

      video.addEventListener("timeupdate", () => {
        if (isVideoAtEnd()) {
          if (!videoHasEnded) {
            videoHasEnded = true;
            setOverlay(true);
          }
        } else if (!video.paused && video.currentTime > 0.01) {
          setOverlay(false);
        }
      });

      video.addEventListener("ended", () => {
        videoHasEnded = true;
        setOverlay(true);
        setTimeout(() => {
          if (videoHasEnded) {
            video.currentTime = 0;
            setOverlay(true);
          }
        }, 150);
        sendMessage("VIDEO_ENDED", {
          hasEnded: true,
          duration: video.duration,
          currentTime: video.currentTime
        });
      });

      video.addEventListener("seeked", () => {
        if (isVideoAtEnd()) {
          videoHasEnded = true;
          setOverlay(true);
        }
        if (!isReceivingSeek) {
          sendMessage("VIDEO_SEEKED", { time: video.currentTime });
        }
      });

      // Prevent interactions
      video.addEventListener("contextmenu", (e) => e.preventDefault());
      video.addEventListener("click", (e) => e.preventDefault());

      // Initialize
      video.controls = false;
      setOverlay(false);

      // Notify parent window
      window.addEventListener("load", () => {
        sendMessage("VIDEO_WINDOW_READY");
      });
    </script>
  </body>
</html>
