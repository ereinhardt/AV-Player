<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Player</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: black;
        overflow: hidden;
      }

      #video-player {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: black;
      }

      #video-player::-webkit-media-controls {
        display: none !important;
      }

      #black-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 9999;
        display: none;
      }
    </style>
  </head>
  <body>
    <video id="video-player" muted></video>
    <div id="black-overlay"></div>

    <script>
      let isReceivingSeek = false;
      let videoHasEnded = false;
      let isLoopRestarting = false;

      const video = document.getElementById("video-player");
      const overlay = document.getElementById("black-overlay");

      // Show or hide black overlay based on video end state
      function updateOverlay() {
        const shouldShow = videoHasEnded;
        overlay.style.display = shouldShow ? "block" : "none";
      }

      // Check if video has reached the end with small tolerance
      function isVideoAtEnd() {
        return (
          video.ended ||
          (video.duration && video.currentTime >= video.duration - 1)
        ); //!IMPORTANT
      }

      // Send message to parent window if available
      function sendMessage(type, data = {}) {
        if (window.opener) {
          try {
            window.opener.postMessage({ type, data }, window.location.origin);
          } catch (e) {}
        }
      }

      // Reset video to beginning and optionally start playback
      function resetVideo(shouldPlay = false) {
        const src = video.src;
        video.pause();
        video.src = "";
        video.load();
        video.src = src;
        video.load();
        video.currentTime = 0;

        if (shouldPlay) {
          isLoopRestarting = true;
          setTimeout(() => {
            video
              .play()
              .then(() => {
                isLoopRestarting = false;
                videoHasEnded = false;
              })
              .catch(() => {
                isLoopRestarting = false;
              });
          }, 100);
        } else {
          videoHasEnded = false;
        }
        updateOverlay();
      }

      window.addEventListener("message", (event) => {
        if (event.origin !== window.location.origin) return;

        const { type, data } = event.data;

        switch (type) {
          case "LOAD_VIDEO":
            videoHasEnded = false;
            isLoopRestarting = false;
            video.src = data.url;
            video.muted = true;
            video.controls = false;
            updateOverlay();
            break;

          case "PLAY":
            if ((!videoHasEnded && !video.ended) || isLoopRestarting) {
              videoHasEnded = false;
              video.play().catch((e) => console.warn("Play failed:", e));
            }
            updateOverlay();
            break;

          case "PAUSE":
            video.pause();
            updateOverlay();
            break;

          case "SEEK":
            if (data?.time !== undefined && !videoHasEnded) {
              isReceivingSeek = true;
              video.currentTime = data.time;
              setTimeout(() => {
                isReceivingSeek = false;
              }, 100);
            }
            break;

          case "SET_PLAYBACK_RATE":
            if (data?.rate !== undefined) {
              video.playbackRate = data.rate;
            }
            break;

          case "GET_VIDEO_STATUS":
            sendMessage("VIDEO_STATUS_RESPONSE", {
              hasEnded: videoHasEnded,
              ended: video.ended,
              paused: video.paused,
              currentTime: video.currentTime,
              duration: video.duration,
              isLoopRestarting: isLoopRestarting,
            });
            break;

          case "RESTART_VIDEO":
            resetVideo(true);
            break;

          case "RESET_VIDEO":
            resetVideo(false);
            break;
        }
      });

      video.addEventListener("play", () => {
        videoHasEnded = false;
        updateOverlay();
        if (!isReceivingSeek) {
          sendMessage("VIDEO_PLAY");
        }
      });

      video.addEventListener("pause", () => {
        updateOverlay();
        if (!isReceivingSeek) {
          sendMessage("VIDEO_PAUSE");
        }
      });

      video.addEventListener("timeupdate", () => {
        const wasEnded = videoHasEnded;
        videoHasEnded = isVideoAtEnd();
        if (videoHasEnded !== wasEnded) {
          updateOverlay();
        }
      });

      video.addEventListener("ended", () => {
        videoHasEnded = true;
        updateOverlay();
        sendMessage("VIDEO_ENDED", {
          hasEnded: true,
          duration: video.duration,
          currentTime: video.currentTime,
        });
      });

      video.addEventListener("seeked", () => {
        videoHasEnded = isVideoAtEnd();
        updateOverlay();
        if (!isReceivingSeek) {
          sendMessage("VIDEO_SEEKED", { time: video.currentTime });
        }
      });

      video.addEventListener("contextmenu", (e) => e.preventDefault());
      video.addEventListener("click", (e) => e.preventDefault());

      video.controls = false;
      updateOverlay();

      window.addEventListener("load", () => {
        sendMessage("VIDEO_WINDOW_READY");
      });
    </script>
  </body>
</html>
