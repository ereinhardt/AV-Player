<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
        }
        
        #video-player {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: black;
            display: block;
        }
        
        /* Hide any default browser video controls completely */
        #video-player::-webkit-media-controls {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-panel {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-play-button {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-volume-slider {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-timeline {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-current-time-display {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-time-remaining-display {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-volume-control-container {
            display: none !important;
        }
        
        /* Firefox */
        #video-player::-moz-media-controls {
            display: none !important;
        }
        
        /* Edge/IE */
        #video-player::-ms-media-controls {
            display: none !important;
        }
        
        /* Make sure no poster frame is shown */
        #video-player[poster] {
            background: black;
        }
    </style>
</head>
<body class="video-window-body">
    <video id="video-player" class="video-window-video" muted style="width: 100%; height: 100%; object-fit: contain; background: black;"></video>
    <div id="black-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10;"></div>

    <script>
        let isReceivingSeek = false;
        let lastManualSeekTime = 0;
        
        window.addEventListener('load', () => {
            if (window.opener) {
                window.opener.postMessage({
                    type: 'VIDEO_WINDOW_READY'
                }, window.location.origin);
            }
        });
        
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) {
                return;
            }
            
            try {
                const { type, data } = event.data;
                const video = document.getElementById('video-player');
                
                if (!video) {
                    return;
                }
                
                switch (type) {
                    case 'LOAD_VIDEO':
                        try {
                            console.log('Loading video:', data.filename, 'URL:', data.url);
                            video.src = data.url;
                            video.muted = true;
                            video.controls = false; // Ensure no controls
                            video.style.display = 'block';
                            video.style.width = '100%';
                            video.style.height = '100%';
                            video.style.objectFit = 'contain';
                            video.style.background = 'black';
                            
                            // Remove old event listeners to avoid duplicates
                            video.removeEventListener('loadstart', video._loadStartHandler);
                            video.removeEventListener('canplay', video._canPlayHandler);
                            video.removeEventListener('error', video._errorHandler);
                            video.removeEventListener('loadeddata', video._loadedDataHandler);
                            
                            // Create new handlers
                            video._loadStartHandler = () => {
                                console.log('Video load started');
                            };
                            video._canPlayHandler = () => {
                                console.log('Video can play');
                            };
                            video._errorHandler = (e) => {
                                console.error('Video error:', e);
                            };
                            video._loadedDataHandler = () => {
                                console.log('Video data loaded');
                            };
                            
                            // Add event listeners
                            video.addEventListener('loadstart', video._loadStartHandler);
                            video.addEventListener('canplay', video._canPlayHandler);
                            video.addEventListener('error', video._errorHandler);
                            video.addEventListener('loadeddata', video._loadedDataHandler);
                            
                            video.load(); // Force reload
                        } catch (error) {
                            // Error setting video source
                        }
                        break;
                        
                    case 'PLAY':
                        let blackOverlayPlay = document.getElementById('black-overlay');
                        if (blackOverlayPlay) {
                            blackOverlayPlay.style.display = 'none';
                        }
                        video.play().catch(e => {});
                        break;
                        
                    case 'PAUSE':
                        video.pause();
                        break;
                        
                    case 'SEEK':
                        if (data && typeof data.time === 'number') {
                            isReceivingSeek = true;
                            
                            const timeDiff = Math.abs(video.currentTime - data.time);
                            
                            if (timeDiff > 0.2) {
                                video.currentTime = data.time;
                            }
                            
                            setTimeout(() => { isReceivingSeek = false; }, 300);
                        }
                        break;
                        
                    case 'SET_PLAYBACK_RATE':
                        if (data && typeof data.rate === 'number') {
                            video.playbackRate = data.rate;
                        }
                        break;
                        
                    case 'SET_LOOP':
                        // Loop is now handled centrally by playback.js
                        // Individual video loop is disabled
                        video.loop = false;
                        break;
                        
                    case 'RESTART_VIDEO':
                        let blackOverlayRestart = document.getElementById('black-overlay');
                        if (blackOverlayRestart) {
                            blackOverlayRestart.style.display = 'none';
                        }
                        video.currentTime = 0;
                        // Always try to play when restarting, regardless of current state
                        video.play().catch(e => {});
                        break;
                }
            } catch (error) {}
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video-player');
            
            if (!video) {
                return;
            } else {
                // Ensure no controls are shown
                video.controls = false;
                video.setAttribute('controls', 'false');
                video.removeAttribute('controls');
            }
            
            video.addEventListener('play', () => {
                // Hide black overlay when video starts playing
                const blackOverlay = document.getElementById('black-overlay');
                if (blackOverlay) {
                    blackOverlay.style.display = 'none';
                }
                
                if (window.opener && !isReceivingSeek) {
                    try {
                        window.opener.postMessage({ type: 'VIDEO_PLAY' }, window.location.origin);
                    } catch (e) {}
                }
            });
            
            video.addEventListener('pause', () => {
                if (window.opener && !isReceivingSeek) {
                    try {
                        window.opener.postMessage({ type: 'VIDEO_PAUSE' }, window.location.origin);
                    } catch (e) {}
                }
            });
            
            video.addEventListener('seeking', () => {
                if (!isReceivingSeek) {
                    lastManualSeekTime = Date.now();
                }
            });
            
            video.addEventListener('seeked', () => {
                if (window.opener && !isReceivingSeek) {
                    const now = Date.now();
                    if (now - lastManualSeekTime < 1000) {
                        try {
                            window.opener.postMessage({ 
                                type: 'VIDEO_SEEKED', 
                                data: { time: video.currentTime } 
                            }, window.location.origin);
                        } catch (e) {}
                    }
                }
            });
            
            // Additional safety: hide overlay when video is actually playing
            video.addEventListener('playing', () => {
                const blackOverlay = document.getElementById('black-overlay');
                if (blackOverlay) {
                    blackOverlay.style.display = 'none';
                }
            });
            
            // Hide overlay when video time updates (playing actively)
            video.addEventListener('timeupdate', () => {
                if (!video.paused && !video.ended) {
                    const blackOverlay = document.getElementById('black-overlay');
                    if (blackOverlay && blackOverlay.style.display !== 'none') {
                        blackOverlay.style.display = 'none';
                    }
                }
            });
            
            // Prevent right-click context menu on video
            video.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            // Prevent any mouse interaction that might show controls
            video.addEventListener('mousedown', (e) => {
                e.preventDefault();
            });
            
            video.addEventListener('mouseup', (e) => {
                e.preventDefault();
            });
            
            video.addEventListener('click', (e) => {
                e.preventDefault();
            });
            
            video.addEventListener('dblclick', (e) => {
                e.preventDefault();
            });
            
            // Show black overlay when video ends instead of showing any frame
            video.addEventListener('ended', () => {
                const blackOverlay = document.getElementById('black-overlay');
                if (blackOverlay) {
                    blackOverlay.style.display = 'block';
                }
                // Also post message to parent about video ending
                if (window.opener && !isReceivingSeek) {
                    try {
                        window.opener.postMessage({ type: 'VIDEO_ENDED' }, window.location.origin);
                    } catch (e) {}
                }
            });
            
            if (window.opener) {
                try {
                    window.opener.postMessage({ type: 'VIDEO_WINDOW_READY' }, window.location.origin);
                } catch (e) {
                    // Error sending ready message
                }
            }
        });
    </script>
</body>
</html>
