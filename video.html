<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
        }
        
        #video-player {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: black;
            display: block;
            /* Windows-specific fixes */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
        }
        
        /* Hide any default browser video controls completely */
        #video-player::-webkit-media-controls {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-panel {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-play-button {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-volume-slider {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-timeline {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-current-time-display {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-time-remaining-display {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }
        
        #video-player::-webkit-media-controls-volume-control-container {
            display: none !important;
        }
        
        /* Firefox */
        #video-player::-moz-media-controls {
            display: none !important;
        }
        
        /* Edge/IE */
        #video-player::-ms-media-controls {
            display: none !important;
        }
        
        /* Make sure no poster frame is shown */
        #video-player[poster] {
            background: black;
        }
    </style>
</head>
<body class="video-window-body">
    <video id="video-player" class="video-window-video" muted style="width: 100%; height: 100%; object-fit: contain; background: black;"></video>
    <div id="black-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10; opacity: 1; visibility: visible; pointer-events: none;"></div>

    <script>
        let isReceivingSeek = false;
        let lastManualSeekTime = 0;
        let overlayTimeout = null;
        let isLoopRestarting = false;
        
        // Function to preemptively show overlay (Windows first-frame prevention)
        function preemptiveShowOverlay() {
            const blackOverlay = document.getElementById('black-overlay');
            if (blackOverlay) {
                blackOverlay.style.display = 'block';
                blackOverlay.style.zIndex = '2000'; // Higher than video
                blackOverlay.style.visibility = 'visible';
                blackOverlay.style.opacity = '1';
                blackOverlay.offsetHeight; // Force immediate repaint
            }
        }
        
        // Function to safely hide overlay with Windows compatibility
        function hideOverlay() {
            // Don't hide overlay if we're in the middle of a loop restart
            if (isLoopRestarting) {
                return;
            }
            
            const blackOverlay = document.getElementById('black-overlay');
            if (blackOverlay) {
                blackOverlay.style.display = 'none';
                // Force repaint on Windows browsers
                blackOverlay.style.visibility = 'hidden';
                blackOverlay.offsetHeight; // Trigger reflow
                blackOverlay.style.visibility = 'visible';
            }
        }
        
        // Function to safely show overlay with Windows compatibility
        function showOverlay() {
            const blackOverlay = document.getElementById('black-overlay');
            if (blackOverlay) {
                blackOverlay.style.display = 'block';
                blackOverlay.style.zIndex = '1000';
                blackOverlay.style.visibility = 'visible';
                blackOverlay.style.opacity = '1';
                // Force repaint on Windows browsers
                blackOverlay.offsetHeight; // Trigger reflow
            }
        }
        
        window.addEventListener('load', () => {
            if (window.opener) {
                window.opener.postMessage({
                    type: 'VIDEO_WINDOW_READY'
                }, window.location.origin);
            }
        });
        
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) {
                return;
            }
            
            try {
                const { type, data } = event.data;
                const video = document.getElementById('video-player');
                
                if (!video) {
                    return;
                }
                
                switch (type) {
                    case 'LOAD_VIDEO':
                        try {
                            video.src = data.url;
                            video.muted = true;
                            video.controls = false; // Ensure no controls
                            video.style.display = 'block';
                            video.style.width = '100%';
                            video.style.height = '100%';
                            video.style.objectFit = 'contain';
                            video.style.background = 'black';
                            
                            // Hide overlay when loading new video
                            hideOverlay();
                            
                            // Remove old event listeners to avoid duplicates
                            video.removeEventListener('loadstart', video._loadStartHandler);
                            video.removeEventListener('canplay', video._canPlayHandler);
                            video.removeEventListener('error', video._errorHandler);
                            video.removeEventListener('loadeddata', video._loadedDataHandler);
                            
                            // Create new handlers
                            video._loadStartHandler = () => {
                                // Video load started
                            };
                            video._canPlayHandler = () => {
                                // Video can play - ensure overlay is hidden
                                const overlay = document.getElementById('black-overlay');
                                if (overlay && !video.paused && !video.ended) {
                                    overlay.style.display = 'none';
                                }
                            };
                            video._errorHandler = (e) => {
                                console.error('Video error:', e);
                            };
                            video._loadedDataHandler = () => {
                                // Video data loaded
                            };
                            
                            // Add event listeners
                            video.addEventListener('loadstart', video._loadStartHandler);
                            video.addEventListener('canplay', video._canPlayHandler);
                            video.addEventListener('error', video._errorHandler);
                            video.addEventListener('loadeddata', video._loadedDataHandler);
                            
                            video.load(); // Force reload
                        } catch (error) {
                            // Error setting video source
                        }
                        break;
                        
                    case 'PLAY':
                        hideOverlay();
                        video.play().catch(e => {});
                        break;
                        
                    case 'PAUSE':
                        video.pause();
                        break;
                        
                    case 'SEEK':
                        if (data && typeof data.time === 'number') {
                            isReceivingSeek = true;
                            
                            const timeDiff = Math.abs(video.currentTime - data.time);
                            
                            if (timeDiff > 0.2) {
                                video.currentTime = data.time;
                            }
                            
                            setTimeout(() => { isReceivingSeek = false; }, 300);
                        }
                        break;
                        
                    case 'SET_PLAYBACK_RATE':
                        if (data && typeof data.rate === 'number') {
                            video.playbackRate = data.rate;
                        }
                        break;
                        
                    case 'SET_LOOP':
                        // Loop is now handled centrally by playback.js
                        // Individual video loop is disabled
                        video.loop = false;
                        break;
                        
                    case 'RESTART_VIDEO':
                        // Set flag to prevent premature overlay hiding
                        isLoopRestarting = true;
                        
                        // Clear any pending overlay operations
                        if (overlayTimeout) {
                            clearTimeout(overlayTimeout);
                            overlayTimeout = null;
                        }
                        
                        // IMMEDIATELY show overlay to prevent any first frame visibility
                        preemptiveShowOverlay();
                        
                        // Pause video first to ensure clean state
                        video.pause();
                        
                        // Wait a moment for pause to take effect
                        setTimeout(() => {
                            // Keep overlay visible and reset video
                            preemptiveShowOverlay();
                            video.currentTime = 0;
                            
                            // Wait for reset to complete
                            setTimeout(() => {
                                // Start playing with overlay still visible
                                video.play().then(() => {
                                    // Wait for video to actually start playing
                                    setTimeout(() => {
                                        // Only now check if we can hide overlay
                                        if (video.currentTime > 0.1 && !video.paused && !video.ended) {
                                            isLoopRestarting = false;
                                            hideOverlay();
                                        } else {
                                            // Video not properly started, try again
                                            setTimeout(() => {
                                                if (video.currentTime > 0.1 && !video.paused && !video.ended) {
                                                    isLoopRestarting = false;
                                                    hideOverlay();
                                                }
                                            }, 100);
                                        }
                                    }, 150);
                                }).catch(e => {
                                    // Play failed, reset flag
                                    isLoopRestarting = false;
                                });
                            }, 50);
                        }, 30);
                        break;
                }
            } catch (error) {}
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video-player');
            
            if (!video) {
                return;
            } else {
                // Ensure no controls are shown
                video.controls = false;
                video.setAttribute('controls', 'false');
                video.removeAttribute('controls');
            }
            
            video.addEventListener('play', () => {
                // Hide black overlay when video starts playing
                hideOverlay();
                
                if (window.opener && !isReceivingSeek) {
                    try {
                        window.opener.postMessage({ type: 'VIDEO_PLAY' }, window.location.origin);
                    } catch (e) {}
                }
            });
            
            video.addEventListener('pause', () => {
                if (window.opener && !isReceivingSeek) {
                    try {
                        window.opener.postMessage({ type: 'VIDEO_PAUSE' }, window.location.origin);
                    } catch (e) {}
                }
            });
            
            video.addEventListener('seeking', () => {
                if (!isReceivingSeek) {
                    lastManualSeekTime = Date.now();
                }
            });
            
            video.addEventListener('seeked', () => {
                if (window.opener && !isReceivingSeek) {
                    const now = Date.now();
                    if (now - lastManualSeekTime < 1000) {
                        try {
                            window.opener.postMessage({ 
                                type: 'VIDEO_SEEKED', 
                                data: { time: video.currentTime } 
                            }, window.location.origin);
                        } catch (e) {}
                    }
                }
            });
            
            // Additional safety: hide overlay when video is actually playing
            video.addEventListener('playing', () => {
                // Only hide if video has actually progressed
                if (video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Hide overlay when video time updates (playing actively)
            video.addEventListener('timeupdate', () => {
                // Only hide overlay if video has progressed beyond first frames
                if (!video.paused && !video.ended && video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Additional safety: hide overlay when video metadata is loaded and ready
            video.addEventListener('loadedmetadata', () => {
                if (!video.paused && !video.ended && video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Video can play through without stopping - hide overlay if playing
            video.addEventListener('canplaythrough', () => {
                if (!video.paused && !video.ended && video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Windows-specific: Handle video state changes
            video.addEventListener('loadstart', () => {
                // Video started loading - prepare for playback
            });
            
            video.addEventListener('progress', () => {
                // Video is downloading - ensure overlay is ready
                if (!video.paused && !video.ended && video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Windows-specific: Handle video ready states
            video.addEventListener('canplay', () => {
                if (!video.paused && !video.ended && video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Windows-specific: Force overlay management on video source changes
            video.addEventListener('durationchange', () => {
                if (!video.paused && !video.ended && video.currentTime > 0.1 && !isLoopRestarting) {
                    hideOverlay();
                }
            });
            
            // Prevent right-click context menu on video
            video.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            // Prevent any mouse interaction that might show controls
            video.addEventListener('mousedown', (e) => {
                e.preventDefault();
            });
            
            video.addEventListener('mouseup', (e) => {
                e.preventDefault();
            });
            
            video.addEventListener('click', (e) => {
                e.preventDefault();
            });
            
            video.addEventListener('dblclick', (e) => {
                e.preventDefault();
            });
            
            // Show black overlay when video ends instead of showing any frame
            video.addEventListener('ended', () => {
                // Windows-specific: Immediate overlay show
                showOverlay();
                
                // Windows-specific: Additional safety check
                setTimeout(() => {
                    showOverlay();
                }, 50);
                
                // Also post message to parent about video ending
                if (window.opener && !isReceivingSeek) {
                    try {
                        window.opener.postMessage({ type: 'VIDEO_ENDED' }, window.location.origin);
                    } catch (e) {}
                }
            });
            
            if (window.opener) {
                try {
                    window.opener.postMessage({ type: 'VIDEO_WINDOW_READY' }, window.location.origin);
                } catch (e) {
                    // Error sending ready message
                }
            }
        });
    </script>
</body>
</html>
